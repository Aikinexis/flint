<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test History Migration</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1 {
      color: #60a5fa;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #2563eb;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
    }
    .log {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .success {
      color: #10b981;
    }
    .error {
      color: #ef4444;
    }
    .info {
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <h1>History Migration Test</h1>
  
  <div class="section">
    <h2>Setup Test Data</h2>
    <button onclick="createTestHistory()">Create Test History Items</button>
    <button onclick="clearTestData()">Clear All Test Data</button>
  </div>

  <div class="section">
    <h2>Migration</h2>
    <button onclick="runMigration()">Run Migration</button>
    <button onclick="checkMigrationStatus()">Check Migration Status</button>
  </div>

  <div class="section">
    <h2>Verify Results</h2>
    <button onclick="viewProjects()">View Projects</button>
    <button onclick="viewSnapshots()">View Snapshots</button>
    <button onclick="viewHistory()">View Old History</button>
  </div>

  <div class="section">
    <h2>Log Output</h2>
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    import { StorageService } from './dist/services/storage.js';

    window.StorageService = StorageService;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    window.createTestHistory = async function() {
      try {
        log('Creating test history items...', 'info');
        
        const testItems = [
          {
            type: 'generate',
            originalText: 'Write about AI',
            resultText: 'Artificial Intelligence is transforming the world...',
            metadata: {}
          },
          {
            type: 'rewrite',
            originalText: 'This is a test',
            resultText: 'This serves as an examination',
            metadata: { preset: 'formal' }
          },
          {
            type: 'summarize',
            originalText: 'Long text here...',
            resultText: '• Key point 1\n• Key point 2',
            metadata: { mode: 'key-points' }
          }
        ];

        for (const item of testItems) {
          await StorageService.saveHistoryItem(item);
        }

        log(`✓ Created ${testItems.length} test history items`, 'success');
      } catch (error) {
        log(`✗ Failed to create test history: ${error.message}`, 'error');
      }
    };

    window.clearTestData = async function() {
      try {
        log('Clearing all test data...', 'info');
        
        // Clear history
        await StorageService.clearHistory();
        
        // Clear projects
        const projects = await StorageService.getProjects();
        for (const project of projects) {
          await StorageService.deleteProject(project.id);
        }
        
        // Reset migration flag
        await StorageService.updateSettings({ historyMigrated: false });
        
        log('✓ All test data cleared', 'success');
      } catch (error) {
        log(`✗ Failed to clear test data: ${error.message}`, 'error');
      }
    };

    window.runMigration = async function() {
      try {
        log('Running migration...', 'info');
        
        const result = await StorageService.migrateHistoryToSnapshots();
        
        if (result.success) {
          log(`✓ Migration successful: ${result.migratedCount} items migrated`, 'success');
          if (result.projectId) {
            log(`  Created project: ${result.projectId}`, 'info');
          }
        } else {
          log(`✗ Migration failed: ${result.error}`, 'error');
        }
      } catch (error) {
        log(`✗ Migration error: ${error.message}`, 'error');
      }
    };

    window.checkMigrationStatus = async function() {
      try {
        const settings = await StorageService.getSettings();
        const status = settings.historyMigrated ? 'COMPLETED' : 'NOT COMPLETED';
        log(`Migration status: ${status}`, settings.historyMigrated ? 'success' : 'info');
      } catch (error) {
        log(`✗ Failed to check status: ${error.message}`, 'error');
      }
    };

    window.viewProjects = async function() {
      try {
        const projects = await StorageService.getProjects();
        log(`Found ${projects.length} project(s):`, 'info');
        projects.forEach(p => {
          log(`  - ${p.title} (ID: ${p.id})`, 'info');
          log(`    Content: ${p.content.substring(0, 50)}...`, 'info');
        });
      } catch (error) {
        log(`✗ Failed to view projects: ${error.message}`, 'error');
      }
    };

    window.viewSnapshots = async function() {
      try {
        const projects = await StorageService.getProjects();
        if (projects.length === 0) {
          log('No projects found', 'info');
          return;
        }

        for (const project of projects) {
          const snapshots = await StorageService.getSnapshots(project.id);
          log(`Project "${project.title}" has ${snapshots.length} snapshot(s):`, 'info');
          snapshots.forEach(s => {
            log(`  - ${s.actionDescription} (${s.actionType})`, 'info');
            log(`    Timestamp: ${new Date(s.timestamp).toLocaleString()}`, 'info');
          });
        }
      } catch (error) {
        log(`✗ Failed to view snapshots: ${error.message}`, 'error');
      }
    };

    window.viewHistory = async function() {
      try {
        const history = await StorageService.getHistory();
        log(`Found ${history.length} old history item(s):`, 'info');
        history.forEach(h => {
          log(`  - ${h.type}: ${h.originalText.substring(0, 30)}...`, 'info');
        });
      } catch (error) {
        log(`✗ Failed to view history: ${error.message}`, 'error');
      }
    };

    // Initial log
    log('Test page loaded. Ready to test migration.', 'success');
  </script>
</body>
</html>
